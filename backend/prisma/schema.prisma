generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// USER – CÁN BỘ QUẢN LÝ
//////////////////////////////////////////////////////

model User {
  id             Int              @id @default(autoincrement())
  username       String           @unique @db.VarChar(30)
  password       String           @db.VarChar(255)
  fullname       String?           @db.VarChar(50)
  role           Role
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())

  managedChanges ResidentChange[] @relation("UserManageChange")
  managedFees    FeeRecord[]      @relation("UserManageFee")

  receivedNotifications NotificationRecipient[]

  householdId Int?   @unique
  household   Household? @relation("HouseholdAccount", fields: [householdId], references: [id])
}

enum Role {
  HEAD
  DEPUTY
  ACCOUNTANT
  HOUSEHOLD
}

//////////////////////////////////////////////////////
// HOUSEHOLD – HỘ KHẨU
//////////////////////////////////////////////////////

model Household {
  id               Int       @id @default(autoincrement())
  account          User?     @relation("HouseholdAccount")

  householdCode    String    @unique @db.VarChar(9) // MÃ HỘ KHẨU (nghiệp vụ)
  address          String    @db.VarChar(100)

  registrationDate DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  status           Int       @default(1)
  // 0: inactive / locked
  // 1: active

  ownerId          Int?      @unique
  owner            Resident? @relation("HouseholdOwner", fields: [ownerId], references: [id])

  residents        Resident[]
  feeRecords       FeeRecord[]

  @@index([status])
}

//////////////////////////////////////////////////////
// RESIDENT – NHÂN KHẨU
//////////////////////////////////////////////////////

model Resident {
  id              Int      @id @default(autoincrement())

  residentCCCD    String?  @unique
  fullname        String   @db.VarChar(100)
  dob             DateTime
  gender          String?  @db.VarChar(1)

  ethnicity       String?  @db.VarChar(50)   // dân tộc
  religion        String?  @db.VarChar(50)   // tôn giáo
  nationality     String   @db.VarChar(50)   // quốc tịch
  hometown        String?  @db.VarChar(100)  // quê quán
  occupation      String?  @db.VarChar(100)  // nghề nghiệp

  relationToOwner String?  @db.VarChar(50)

  status          Int      @default(0)
  // 0: active
  // 1: temporary
  // 2: absent
  // 3: moved_out
  // 4: deceased

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  householdId     Int?
  household       Household? @relation(fields: [householdId], references: [id])

  ownerOf         Household? @relation("HouseholdOwner")
  changes         ResidentChange[]

  @@index([householdId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// RESIDENT CHANGE – BIẾN ĐỘNG NHÂN KHẨU
//////////////////////////////////////////////////////

model ResidentChange {
  id Int @id @default(autoincrement())

  changeType Int
  // 0: birth
  // 1: temp_residence
  // 2: temp_absence
  // 3: move_in
  // 4: move_out
  // 5: split_household
  // 6: change_household_head
  // 7: death

  fromAddress    String?
  toAddress      String?
  fromDate       DateTime
  toDate         DateTime?
  reason         String?

  extraData      Json?

  approvalStatus Int
  // 0: pending
  // 1: approved
  // 2: rejected

  residentId Int?
  resident   Resident? @relation(fields: [residentId], references: [id])

  managerId Int?
  manager   User? @relation("UserManageChange", fields: [managerId], references: [id])

  createdAt DateTime @default(now())

  @@index([residentId])
  @@index([managerId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// FEE – THU PHÍ
//////////////////////////////////////////////////////

model FeeType {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)

  shortDescription String?  @db.VarChar(255)
  longDescription  String?

  isMandatory Boolean  @default(true)
  unitPrice   Float?
  isActive    Boolean  @default(true)
  fromDate    DateTime?
  toDate      DateTime?

  feeRecords FeeRecord[]
}

enum PaymentMethod {
  OFFLINE
  ONLINE
}

model FeeRecord {
  id          Int     @id @default(autoincrement())
  amount      Float
  status      Int
  // 0: unpaid
  // 1: partial
  // 2: paid
  // 3: online paid 

  method      PaymentMethod   @default(OFFLINE)
  /// OFFLINE: kế toán thu trực tiếp
  /// ONLINE: cư dân thanh toán QR
  
  description String?

  householdId Int
  household   Household @relation(fields: [householdId], references: [id])

  feeTypeId   Int
  feeType     FeeType @relation(fields: [feeTypeId], references: [id])

  managerId   Int
  manager     User @relation("UserManageFee", fields: [managerId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([householdId])
  @@index([feeTypeId])
  @@index([managerId])
  @@index([createdAt])
  @@index([method])

}

// THÔNG BÁO

model Notification {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(200)
  message   String   @db.Text
  type      String   // "FEE_REMINDER", "ANNOUNCEMENT", "PAYMENT_SUCCESS"
  relatedId Int?     // ID của đối tượng liên quan (ID hóa đơn, ID bài viết...)
  createdAt DateTime @default(now())
  recipients NotificationRecipient[]
}

model NotificationRecipient {
  id             Int          @id @default(autoincrement())
  isRead         Boolean      @default(false)
  readAt         DateTime?    // Thời điểm đọc
  userId         Int
  user           User         @relation(fields: [userId], references: [id])
  notificationId Int
  notification   Notification @relation(fields: [notificationId], references: [id])

  @@index([userId])
  @@index([isRead])
}