generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int        @id @default(autoincrement())
  username   String     @unique @db.VarChar(30)
  password   String     @db.VarChar(255)
  fullname   String     @db.VarChar(50)
  phone      String     @db.VarChar(12)
  createdAt  DateTime   @default(now())
  role       Role
  isActive   Boolean    @default(true)

  household  Household?
  managedFeeRecords FeeRecord[]      @relation("UserManageFee")
  managedChanges    ResidentChange[] @relation("UserManageChange")
}

enum Role {
  HEAD
  DEPUTY
  ACCOUNTANT
  HOUSEHOLD
}

model Household {
  id                Int        @id @default(autoincrement())
  address           String     @db.VarChar(100)
  registrationDate  DateTime
  nbrOfResident     Int
  status            Int        // 0 active, 1 locked

  userId            Int?       @unique
  user              User?      @relation(fields: [userId], references: [id])

  ownerId           Int?
  owner             Resident?  @relation("OwnerResident", fields: [ownerId], references: [id])

  residents         Resident[]
  feeRecords        FeeRecord[]
}

model Resident {
  id                Int        @id @default(autoincrement())
  residentCCCD      String     @unique
  fullname          String     @db.VarChar(100)
  dob               DateTime
  gender            String?    @db.VarChar(1)
  relationToOwner   String
  status            Int        // 0 permanent, 1 temporary, 2 absent, 3 moved_out, 4 deceased
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  householdId       Int
  household         Household  @relation(fields: [householdId], references: [id])

  ownedHouseholds   Household[] @relation("OwnerResident")
  changes           ResidentChange[]
}

model ResidentChange {
  id             Int       @id @default(autoincrement())

  changeType     Int       // 0: birth, 1: temp_residence, 2: temp_absence,
                           // 3: move_in, 4: move_out, 5: update_info,
                           // 6: join_household, 7: split_household, 8: death

  fromAddress    String
  toAddress      String
  fromDate       DateTime
  toDate         DateTime?
  reason         String

  approvalStatus Int       // 0 pending, 1 approved, 2 rejected

  residentId     Int
  resident       Resident   @relation(fields: [residentId], references: [id])

  managerId      Int?
  manager        User?      @relation("UserManageChange", fields: [managerId], references: [id])
}

model FeeType {
  id           Int       @id @default(autoincrement())
  name         String    @db.VarChar(100)
  description  String    @db.VarChar(100)
  isMandatory  Boolean   @default(true)
  unitPrice    Float?
  createdAt    DateTime  @default(now())
  fromDate     DateTime?
  toDate       DateTime?
  isActive     Boolean   @default(true)

  feeRecords   FeeRecord[]
}

model FeeRecord {
  id          Int       @id @default(autoincrement())
  description String?   @db.VarChar(200)
  updatedAt   DateTime  @default(now())
  fundAmount  Float     @default(0)

  status      Int       // 0 unpaid, 1 partially_paid, 2 fully_paid
  isActive    Boolean   @default(true)

  householdId Int
  household   Household @relation(fields: [householdId], references: [id])

  feeTypeId   Int
  feeType     FeeType   @relation(fields: [feeTypeId], references: [id])

  managerId   Int
  manager     User      @relation("UserManageFee", fields: [managerId], references: [id])
}
