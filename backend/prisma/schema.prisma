generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// USER – CÁN BỘ QUẢN LÝ
//////////////////////////////////////////////////////

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(30)
  password  String   @db.VarChar(255)
  fullname  String   @db.VarChar(50)
  phone     String   @db.VarChar(12)
  role      Role
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  managedChanges ResidentChange[] @relation("UserManageChange")
  managedFees    FeeRecord[]      @relation("UserManageFee")
}

enum Role {
  HEAD
  DEPUTY
  ACCOUNTANT
}

//////////////////////////////////////////////////////
// HOUSEHOLD – HỘ KHẨU (THƯỜNG TRÚ)
//////////////////////////////////////////////////////

model Household {
  id               Int      @id @default(autoincrement())
  address          String   @db.VarChar(100)
  registrationDate DateTime
  status           Int // 0 active, 1 locked
  nbrOfResident    Int

  ownerId Int?
  owner   Resident? @relation("OwnerResident", fields: [ownerId], references: [id])

  residents  Resident[]
  feeRecords FeeRecord[]
}

//////////////////////////////////////////////////////
// RESIDENT – NHÂN KHẨU (THƯỜNG TRÚ + TẠM TRÚ)
//////////////////////////////////////////////////////

model Resident {
  id              Int      @id @default(autoincrement())
  residentCCCD    String?  @unique // NULL cho trẻ sơ sinh
  fullname        String   @db.VarChar(100)
  dob             DateTime
  gender          String?  @db.VarChar(1)
  relationToOwner String // HEAD, WIFE, SON, DAUGHTER...

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // THƯỜNG TRÚ (nullable → cho phép tạm trú từ nơi khác)
  householdId Int?
  household   Household? @relation(fields: [householdId], references: [id])

  // Chủ hộ
  ownedHouseholds Household[] @relation("OwnerResident")

  // Biến động nhân khẩu
  changes ResidentChange[]

  // Tạm trú hiện tại
  temporaryResidences TemporaryResidence[]
}

//////////////////////////////////////////////////////
// TEMPORARY RESIDENCE – TẠM TRÚ (TRẠNG THÁI HIỆN TẠI)
//////////////////////////////////////////////////////

model TemporaryResidence {
  id         Int      @id @default(autoincrement())
  residentId Int
  resident   Resident @relation(fields: [residentId], references: [id])

  address  String    @db.VarChar(100)
  fromDate DateTime
  toDate   DateTime?
  status   Int // 0 active, 1 ended

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// RESIDENT CHANGE – BIẾN ĐỘNG / LỊCH SỬ HÀNH CHÍNH
//////////////////////////////////////////////////////

model ResidentChange {
  id Int @id @default(autoincrement())

  changeType Int
  // 0 birth
  // 1 temp_residence
  // 2 temp_absence
  // 3 move_in
  // 4 move_out
  // 5 update_info
  // 6 join_household
  // 7 split_household
  // 8 death
  // 9 change_household_head

  fromAddress String?
  toAddress   String?
  fromDate    DateTime
  toDate      DateTime?
  reason      String?

  approvalStatus Int // 0 pending, 1 approved, 2 rejected

  residentId Int
  resident   Resident @relation(fields: [residentId], references: [id])

  managerId Int?
  manager   User? @relation("UserManageChange", fields: [managerId], references: [id])

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// FEE – THU PHÍ
//////////////////////////////////////////////////////

model FeeType {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  description String?
  isMandatory Boolean   @default(true)
  unitPrice   Float?
  isActive    Boolean   @default(true)
  fromDate    DateTime?
  toDate      DateTime?

  feeRecords FeeRecord[]
}

model FeeRecord {
  id          Int     @id @default(autoincrement())
  amount      Float
  status      Int // 0 unpaid, 1 partial, 2 paid
  description String?

  householdId Int
  household   Household @relation(fields: [householdId], references: [id])

  feeTypeId Int
  feeType   FeeType @relation(fields: [feeTypeId], references: [id])

  managerId Int
  manager   User @relation("UserManageFee", fields: [managerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Fee {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  isMandatory Boolean  @default(false)
  unitPrice   Float?
  status      Int      @default(1)
  transactions Transaction[]
}

model Transaction {
  id          Int      @id @default(autoincrement())
  amount      Float
  date        DateTime @default(now())
  note        String?
  feeId       Int
  householdId Int
  fee         Fee      @relation(fields: [feeId], references: [id])
  household   Household @relation(fields: [householdId], references: [id])
}